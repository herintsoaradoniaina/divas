<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Parser Données</title>
<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: Arial, sans-serif;
    overflow: hidden;
  }

  body {
    display: flex;
    flex-direction: row;
  }

  .left, .right {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
  }

  .left {
    flex: 1;
    min-width: 150px;
    padding: 10px;
    box-sizing: border-box;
  }

  .right {
    flex: 1;
    min-width: 150px;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }

  textarea {
    width: 100%;
    height: 100%;
    padding: 10px;
    font-size: 14px;
    box-sizing: border-box;
    resize: none;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  .header-info {
    font-weight: bold;
    margin-bottom: 8px;
  }

  .controls {
    margin-bottom: 10px;
  }

  button {
    padding: 6px 12px;
    margin-right: 8px;
    cursor: pointer;
    border: 1px solid #888;
    border-radius: 4px;
    background-color: #f0f0f0;
    transition: background 0.2s;
  }

  button:hover {
    background-color: #e0e0e0;
  }

  table {
    flex: 1;
    width: 100%;
    border-collapse: collapse;
    overflow-y: auto;
    display: block;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  table thead {
    display: table;
    width: 100%;
    table-layout: fixed;
  }

  table tbody {
    display: block;
    height: calc(100% - 36px);
    overflow-y: auto;
  }

  th, td {
    padding: 8px 10px;
    border: 1px solid #ccc;
    text-align: left;
    width: 25%;
    box-sizing: border-box;
  }

  th {
    background-color: #f7f7f7;
    font-weight: bold;
  }

  tbody tr:nth-child(odd) {
    background-color: #fafafa;
  }

  tbody tr:hover {
    background-color: #e6f7ff;
  }

  .row-incomplete {
    background-color: #fff0f0 !important;
  }
</style>
</head>
<body>
  <div class="left">
    <textarea id="inputArea" placeholder="Collez vos données ici..."></textarea>
  </div>

  <div class="right">
    <div class="header-info" id="rowCount">Nb Lignes: 0</div>
    <div class="controls">
      <button onclick="copyToClipboard()">Copier dans le presse-papier</button>
    </div>
    <table id="resultTable">
      <thead>
        <tr>
          <th>Categorie</th>
          <th>Nom</th>
          <th>Ingredient</th>
          <th>Prix</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const textarea = document.getElementById("inputArea");
textarea.addEventListener("input", parseData);

function parseData() {
  const text = textarea.value;
  const lines = text.split(/\r?\n/);
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";

  let row = ["", "", "", ""];
  let colIndex = 0;
  let rowCount = 0;

  for (let line of lines) {
    line = line.trim().replace(/\s{2,}/g, " ");
    if (line === "") {
      if (colIndex < 3) { row[colIndex] = ""; colIndex++; }
      continue;
    }

    // Détecte les prix, éventuellement avec un $
    if (/^\d+(\.\d{1,2})\$?$/.test(line)) {
      row[3] = line.replace("$","");
      addRow(tbody, row);
      rowCount++;
      row = ["", "", "", ""];
      colIndex = 0;
    } else {
      if (colIndex < 3) { row[colIndex] = line; colIndex++; }
    }
  }

  if (row.some(cell => cell !== "")) {
    addRow(tbody, row);
    rowCount++;
  }

  document.getElementById("rowCount").textContent = "Nb Lignes: " + rowCount;
  colorDuplicates();
}

function addRow(tbody, row) {
  const tr = document.createElement("tr");
  const incomplete = row.some(cell => cell === "");
  if (incomplete) tr.classList.add("row-incomplete");
  row.forEach(cell => {
    const td = document.createElement("td");
    td.textContent = cell;
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}

function copyToClipboard() {
  const rows = document.querySelectorAll("#resultTable tbody tr");
  let exportText = "";
  rows.forEach(tr => {
    const cells = tr.querySelectorAll("td");
    cells.forEach((td, index) => {
      let value = td.textContent || "";
      if(index === 3 && value === "0.00") value = "";
      exportText += value + "\n";
    });
  });
  navigator.clipboard.writeText(exportText).then(() => {
    alert("Les données ont été copiées dans le presse-papier ✅");
  }).catch(err => {
    console.error("Erreur lors de la copie :", err);
  });
}

function colorDuplicates() {
  const tbody = document.querySelector("#resultTable tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));
  const nameMap = {};
  const colors = ["#ff9999", "#ffff99", "#99ccff", "#99ff99", "#ffcc99", "#cc99ff"];
  let colorIndex = 0;

  rows.forEach(tr => {
    const nameCell = tr.children[1];
    const name = nameCell.textContent.trim();
    if(!name) return;

    if(nameMap[name] !== undefined) {
      nameCell.style.backgroundColor = nameMap[name];
    } else {
      const occurrences = rows.filter(r => r.children[1].textContent.trim() === name);
      if(occurrences.length > 1) {
        const color = colors[colorIndex % colors.length];
        nameMap[name] = color;
        occurrences.forEach(r => r.children[1].style.backgroundColor = color);
        colorIndex++;
      }
    }
  });
}
</script>
</body>
</html>
