<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Visualisation HIT</title>
  <style>
body {
  font-family: 'Segoe UI', sans-serif;
  font-size: 13px;
  background-color: #f4f4f9;
  color: #333;
  margin: 20px;
}

#controls {
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px 15px;
  align-items: center;
  background: #fff;
  padding: 15px 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

#controls input[type="file"],
#controls input[type="text"],
#controls button {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 13px;
}

#controls button {
  background-color: #007bff;
  color: white;
  cursor: pointer;
  transition: background 0.2s ease;
}

#controls button:hover {
  background-color: #0056b3;
}

/* === Alternance de couleur pour asin-block === */
#hitContainer .asin-block.bg-light {
  background-color: #f8f8ff !important;
}
#hitContainer .asin-block.bg-white {
  background-color: #ffffff !important;
}

#hitContainer {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

/* Bloc ASIN */
.asin-block {
  display: flex;
  align-items: flex-start;
  border: 2px solid #999;
  border-left: 6px solid #007bff;
  padding: 14px;
  border-radius: 8px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  gap: 20px;
  width: 100%;
}

/* Infos produit */
.asin-info {
  width: 240px;
  font-weight: bold;
  font-size: 12px;
  color: #333;
}

/* Image produit */
.preview-img {
  width: 4cm;
  height: 4cm;
  object-fit: contain;
  cursor: pointer;
  margin-top: 6px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* Colonnes juges et travailleurs */
.worker-column {
  min-width: 140px;
  max-width: 220px;
  display: flex;
  flex-direction: column;
  align-items: center;
  font-size: 12px;
  text-align: center;
  padding: 6px;
}

.worker-column.judge {
  align-items: flex-start;
  padding: 8px 12px;
  background-color: #fafafa;
  border-right: 1px solid #eee;
  min-width: 160px;
  max-width: 240px;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  font-size: 12px;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin: 0;
  margin-bottom: 3px;
  font-weight: normal;
  font-size: 11.5px;
  white-space: nowrap;
}

.majority {
  background-color: #d4edda;
  padding: 2px 4px;
  border-radius: 4px;
  margin-bottom: 2px;
}

.minority {
  background-color: #f8d7da;
  border: 1px solid #f5c2c7;
  color: #842029;
  padding: 2px 4px;
  border-radius: 4px;
  margin-bottom: 2px;
}

textarea {
  margin-top: 5px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 12px;
  padding: 4px;
  width: 100%;
  resize: vertical;
  min-height: 40px;
}

label select {
  margin-top: 2px;
  padding: 3px;
  font-size: 12px;
}

#floatingASINImage {
  position: fixed;
  top: 50px;
  right: 20px;
  max-width: 300%;
  height: auto;
  z-index: 9999;
  cursor: move;
  border: 2px solid #444;
  background: white;
  display: none;
}

#floatingQueryWrapper {
  position: fixed !important;
  top: 10px;
  right: 10px;
  width: 400px;
  z-index: 9999;
  background-color: white;
  display: none;
  border: 2px solid #ccc;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

#floatingQueryImage {
  width: 100%;
  display: block;
  transition: transform 0.3s ease;
}

#queryBBox {
  position: absolute;
  border: 2px solid red;
  background-color: rgba(255, 0, 0, 0.2);
  display: none;
  pointer-events: none;
  z-index: 10;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #333;
  color: white;
  padding: 10px 14px;
  border-radius: 6px;
  z-index: 10000;
  font-size: 13px;
  opacity: 0.9;
}

#progressOverlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.85);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  backdrop-filter: blur(3px);
}

#progressBox {
  text-align: center;
  background: white;
  padding: 20px 30px;
  border-radius: 20px;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

#progressText {
  font-weight: bold;
  font-size: 18px;
}

.judge-title {
  font-weight: bold;
  font-size: 12px;
  margin-bottom: 6px;
  color: #333;
  text-align: left;
}

#automatisme {
  background-color: #fff4e5;       /* fond l√©ger orange p√¢le */
  border: 2px solid #ff9900;       /* bordure orange vif */
  color: #663300;                  /* texte marron fonc√© */
  font-weight: bold;
  padding: 8px 12px;
  border-radius: 6px;
  width: 100%;
  max-width: 500px;
  box-sizing: border-box;
  user-select: none;               /* d√©sactive la s√©lection texte */
  cursor: not-allowed;             /* curseur interdit (visuel d‚Äôavertissement) */
  transition: background-color 0.3s ease;
}

/* Si on veut permettre quand m√™me la modification au focus */
#automatisme:focus {
  background-color: #fff8dc;       /* un peu plus clair au focus */
  cursor: text;                   /* curseur normal de saisie */
  user-select: text;              /* selection possible */
  outline: none;
  border-color: #ff6600;          /* bordure orange plus vif */
}

/* Notification verte centr√©e */
#notification {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background-color: #d4edda;  /* vert clair */
  color: #155724;             /* vert fonc√© */
  padding: 15px 30px;
  border: 1.5px solid #c3e6cb;
  border-radius: 8px;
  font-weight: bold;
  font-size: 16px;
  z-index: 100000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}
#notification.show {
  opacity: 1;
  pointer-events: auto;
}

#btnSaveData1 {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #007bff;
  color: white;
  font-size: 18px;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

#btnSaveData1:hover {
  background-color: #0056b3;
}

</style>

</head>
<body>
  <div id="controls">
    <input type="file" id="tsvInput" accept=".tsv" />
    <label for="hitIdInput">HITId :</label>
	<input type="text" id="hitIdInput" placeholder="Tapez ou collez un HITId ici" autocomplete="off" style="width: 300px;" />
    <button id="btnShowHIT">Afficher</button>
	<button id="btnSaveData">Terminer</button>
	<label for="sheetUrlInput">URL Google Sheet cible :</label>
    <input type="text" id="sheetUrlInput" placeholder="Entrez l'URL du fichier Google Sheet" style="width: 400px;" />
	<button id="verifierdata">Verifier</button>
	<p id="verifMessage"></p>
	<input type="text" id="automatisme" placeholder="URL de votre script Apps Script (https://script.google.com/macros/s/...)">


	<div id="msgBox"></div>
  </div>

  <div id="hitContainer"></div>
  
  
<!-- üü° Overlay sablier + progression -->
<div id="progressOverlay"
     style="display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: all;
            backdrop-filter: blur(3px);">
  <div id="progressBox"
       style="text-align: center;
              background: white;
              padding: 20px 30px;
              border-radius: 20px;
              box-shadow: 0 0 15px rgba(0,0,0,0.3);">
    <div class="icon" style="margin-bottom: 15px;">
      <img src="https://cdn.pixabay.com/animation/2023/03/12/21/17/21-17-57-902_512.gif"
           alt="Chargement..." width="120">
    </div>
    <div id="progressText" style="font-weight: bold; font-size: 18px;">Chargement...</div>
  </div>
</div>

<!-- Flottant en haut √† droite -->
 <div id="floatingQueryWrapper">
    <div id="queryRotatableWrapper" style="position: relative; width: fit-content;">
      <img id="floatingQueryImage" src="" alt="Image Query" style="display: block; max-width: 100%;" />
      <div id="queryBBox"></div>
    </div>
  </div>

<!-- ‚úÖ Notification qui dispara√Æt -->
<div id="notifMessage" class="notification" style="display:none;"></div>

</body>

  <img id="floatingASINImage" />

<div class="table-wrapper" display="none">
<table id="tableauResultat" style="width: 100%; border-collapse: collapse; margin-bottom: 20px; display: none;">
  <thead>
    <tr>
      <th>hitid</th>
      <th>AssignmentId</th>
      <th>workerid</th>
      <th>Input.imageURL</th>
      <th>Input.bbox</th>
      <th>Input.content</th>
      <th>Answer.output_data</th>
      <th>amazon.image</th>
      <th>Marketplace</th>
      <th>Input.matches</th>
      <th>key</th>
      <th>assin_json</th>
      <th>assin_juge_json</th>
      <th>Comment</th>
    </tr>
  </thead>
  <tbody>
  </div>
    <!-- Les lignes seront ajout√©es ici dynamiquement -->
  </tbody>
</table>
<button id="btnSaveData1">Terminer</button>

<div id="progressOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#ffffffcc; z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
  <div id="progressBox">
    <div class="icon">
      <img src="https://cdn.pixabay.com/animation/2023/03/12/21/17/21-17-57-902_512.gif" alt="Chargement..." width="180">
    </div>
    <div id="progressText" style="font-weight:bold; font-size:18px;">Chargement...</div>
  </div>
</div>
<div id="notification"></div>
</body>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="papaparse_rado.js"></script>
  <script>
// VARIABLES GLOBALES
let currentHitRow = null; // accessible partout
let ATTRIBUTES = [];      // sera d√©fini dynamiquement selon le type

let tsvDataRaw = [];
let currentFileName = "";

document.getElementById('tsvInput').addEventListener('change', function (e) {
  const file = e.target.files[0];
  if (!file) return;

  currentFileName = file.name;
  const lastStoredFile = localStorage.getItem("lastFileName");

  if (lastStoredFile !== currentFileName) {
    // Nouveau fichier charg√© -> suppression donn√©es de jugement + commentaires
    localStorage.removeItem("judgeAnswers");

    // Suppression commentaires li√©s
    Object.keys(localStorage).forEach(k => {
      if (k.startsWith("comment_")) localStorage.removeItem(k);
    });

    localStorage.setItem("lastFileName", currentFileName);
    localStorage.removeItem("currentHitId"); // on efface l'ancien HITId sauvegard√©
  }

Papa.parse(file, {
  header: true,
  delimiter: '\t',
  complete: function (results) {
    tsvDataRaw = results.data;
    showNotification("Fichier charg√© avec succ√®s !");


    // üîç Extraction et concat√©nation de toutes les r√©ponses (minuscules)
    const allAnswers = tsvDataRaw.map(r => r['Answer.output_data']).filter(Boolean);
    let contenuConcat = allAnswers.join(" ").toLowerCase();

    // üß© Liste attributs sp√©cifiques "Fourniture"
    const FOURNITURE_ATTRS = [
      "support_type", "shape", "extra_features", "color",
      "wrong_age_group", "material", "location", "pattern"
    ];

    // üîé D√©tection des attributs par type
    const hasFourniture = FOURNITURE_ATTRS.some(attr => contenuConcat.includes(attr));
    const hasRelevanceLabel = contenuConcat.includes("relevance_label");

    // üéØ Variables pour le type et la couleur fond
    let detectedType = '';
    let backgroundColor = '';
    let baseAttributes = [];

    if (hasFourniture && hasRelevanceLabel) {
      detectedType = "FR IRR"; // Fourniture avec relevance_label
      backgroundColor = '#d1c4e9'; // violet clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category", "wrong_age_group",
        "has_product_difference", "is_wrong_packaging_overlay", "support_type", "shape",
        "size", "extra_features", "color", "material", "location", "pattern", "relevance_label"
      ];
    } else if (hasFourniture && !hasRelevanceLabel) {
      detectedType = "FR"; // Fourniture simple
      backgroundColor = '#f2f0f0'; // gris clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category", "wrong_age_group",
        "has_product_difference", "is_wrong_packaging_overlay", "support_type", "shape",
        "size", "extra_features", "color", "material", "location", "pattern"
      ];
    } else if (!hasFourniture && hasRelevanceLabel) {
      detectedType = "CS IRR"; // CS avec relevance_label
      backgroundColor = '#bbdefb'; // bleu clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category",
        "has_product_difference", "is_wrong_characteristic",
        "is_wrong_size_or_count", "is_wrong_bundle", "is_wrong_packaging_overlay", "relevance_label"
      ];
    } else {
      detectedType = "CS"; // CS simple
      backgroundColor = '#e6f7ff'; // bleu tr√®s clair (modifiable)
      baseAttributes = [
        "asin_image_not_load", "no_difference", "wrong_category",
        "has_product_difference", "is_wrong_characteristic",
        "is_wrong_size_or_count", "is_wrong_bundle", "is_wrong_packaging_overlay"
      ];
    }

    ATTRIBUTES = baseAttributes;
    document.body.style.backgroundColor = backgroundColor;

    console.log("üîç Type d√©tect√© :", detectedType);
    console.log("üì¶ Attributs utilis√©s :", ATTRIBUTES);

    // üéØ Recharger automatiquement le HITId pr√©c√©dent si pr√©sent
    const lastHitId = localStorage.getItem("currentHitId");
    if (lastHitId) {
      document.getElementById('hitIdInput').value = lastHitId;
      setTimeout(() => showHIT(lastHitId), 100);
    }
  }
});


});

function updateHitIdList() {
  const select = document.getElementById('hitIdInput');
  select.innerHTML = ''; // Vide le select

  const hitIdSet = new Set();
  tsvDataRaw.forEach(row => {
    if (row.HITId) {
      const hitId = row.HITId.trim();
      if (!hitIdSet.has(hitId)) {
        hitIdSet.add(hitId);
        const option = document.createElement('option');
        option.value = hitId;
        option.textContent = hitId;  // Affiche le texte visible
        select.appendChild(option);
      }
    }
  });

  // Si un HITId est d√©j√† stock√© dans localStorage, on le s√©lectionne
  const currentHitId = localStorage.getItem("currentHitId");
  if (currentHitId && hitIdSet.has(currentHitId)) {
    select.value = currentHitId;
  } else {
    select.selectedIndex = -1; // Pas de s√©lection par d√©faut
  }
}

///ICI LE CODE DE CLICK BOUTON Afficher
document.getElementById('btnShowHIT').addEventListener('click', () => {
  const newHitId = document.getElementById('hitIdInput').value.trim();
  if (!newHitId) return alert("Aiza ze Hitid f'ahoana hozy Enao?");
  if (!tsvDataRaw.length) return alert("F'angah tsy nampiakatra  TSV aloha f'ahoana hozy Enao?");

  // Suppression commentaires non li√©s au nouveau HITId
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith("comment_") && !k.includes(newHitId)) {
      localStorage.removeItem(k);
    }
  });

  // Sauvegarde HITId courant
  localStorage.setItem("currentHitId", newHitId);

  showHIT(newHitId);
});

///MIFARANA ETO LE CODE DE CLICK BOUTON Afficher

// Affichage automatique au changement ou saisie dans le champ HITId


function showHIT(hitId) {
  const hitContainer = document.getElementById('hitContainer');
  hitContainer.innerHTML = '';

  const rows = tsvDataRaw.filter(r => r.HITId === hitId);
  if (!rows.length) return;

  currentHitRow = rows[0];
  localStorage.setItem("currentHitId", hitId);
  const savedJudgeAnswers = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');

  // ======== Gestion affichage BBOX et image ========
  const queryImg = document.getElementById("floatingQueryImage");
  const queryBBox = document.getElementById("queryBBox");
  const queryWrapper = document.getElementById("floatingQueryWrapper");

  queryImg.src = rows[0]['Input.imageURL'];
  queryWrapper.style.display = "block";

  queryImg.onload = () => {
    makeDraggableAndZoomable(queryWrapper, true);

    let bbox;
    try {
      const bboxRaw = rows[0]['Input.bbox'];
      bbox = typeof bboxRaw === 'string' ? JSON.parse(bboxRaw) : bboxRaw;
      console.log("‚úÖ BBOX d√©tect√©e :", bbox);
    } catch (e) {
      console.warn("‚ùå Bounding box invalide:", rows[0]['Input.bbox']);
      bbox = null;
    }

    const scaleX = queryImg.clientWidth / queryImg.naturalWidth;
    const scaleY = queryImg.clientHeight / queryImg.naturalHeight;

    let x, y, width, height;

    if (bbox && typeof bbox.tlx === 'number' && typeof bbox.brx === 'number' &&
        typeof bbox.tly === 'number' && typeof bbox.bry === 'number') {
      x = bbox.tlx;
      y = bbox.tly;
      width = bbox.brx - bbox.tlx;
      height = bbox.bry - bbox.tly;
    } else {
      console.warn("‚ö†Ô∏è BBOX invalide ou absente. Valeur de test utilis√©e.");
      x = 50; y = 50; width = 120; height = 80;
    }

    queryBBox.style.left = `${x * scaleX}px`;
    queryBBox.style.top = `${y * scaleY}px`;
    queryBBox.style.width = `${width * scaleX}px`;
    queryBBox.style.height = `${height * scaleY}px`;
    queryBBox.style.display = 'block';
  };

  function makeDraggableAndZoomable(wrapper, enableZoom = true) {
    if (!wrapper) return console.error("‚ùå √âl√©ment wrapper non trouv√© pour zoom/d√©placement !");
    let isDragging = false, startX, startY, initialLeft, initialTop;

    wrapper.style.position = 'absolute';
    wrapper.style.cursor = 'grab';

    wrapper.addEventListener('mousedown', (e) => {
      isDragging = true;
      wrapper.style.cursor = 'grabbing';
      startX = e.clientX;
      startY = e.clientY;
      initialLeft = wrapper.offsetLeft;
      initialTop = wrapper.offsetTop;
    });

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      wrapper.style.left = `${initialLeft + dx}px`;
      wrapper.style.top = `${initialTop + dy}px`;
    });

    document.addEventListener('mouseup', () => {
      isDragging = false;
      wrapper.style.cursor = 'grab';
    });

    if (enableZoom) {
      let scale = 1;
      wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = Math.sign(e.deltaY);
        scale += delta * -0.1;
        scale = Math.min(Math.max(0.5, scale), 3);
        wrapper.style.transform = `scale(${scale})`;
        wrapper.style.transformOrigin = 'top left';
      });
    }
  }

  // ======== Pr√©paration liste ASIN ========
  const asinSet = new Set();
  rows.forEach(row => {
    const matchArray = parseFixedJSON(row['Input.matches'] || '[]');
    matchArray.forEach(match => asinSet.add(match.asin));
  });
  const asinList = Array.from(asinSet);

  asinList.forEach(asin => {
    const asinBlock = document.createElement('div');
    asinBlock.className = 'asin-block';
    // ‚úÖ Alternance de couleur uniquement visuelle (sans classe ajout√©e)
	const index = asinList.indexOf(asin);
	asinBlock.style.backgroundColor = (index % 2 === 0) ? '#f9f9fc' : '#ffffff'; // discret et neutre

	
    const asinInfo = document.createElement('div');
    asinInfo.className = 'asin-info';

    const asinLink = document.createElement('a');
    asinLink.href = `https://www.amazon.com/dp/${asin}`;
    asinLink.target = "_blank";
    asinLink.textContent = `ASIN: ${asin}`;
    asinInfo.appendChild(asinLink);

    const matches = parseFixedJSON(rows[0]['Input.matches'] || '[]');
    const asinMatch = matches.find(m => m.asin === asin);
    if (asinMatch && asinMatch.product_title) {
      const title = document.createElement('div');
      title.textContent = asinMatch.product_title;
      title.style.fontSize = "11px";
      title.style.margin = "4px 0";
      asinInfo.appendChild(title);
    }

    const hitDisplay = document.createElement('div');
    hitDisplay.textContent = `HITId: ${hitId}`;
    hitDisplay.style.fontSize = "10px";
    hitDisplay.style.color = "#555";
    hitDisplay.style.marginTop = "4px";
    asinInfo.appendChild(hitDisplay);

    const preview = findImage(rows[0], asin);
    if (preview) {
      const img = document.createElement('img');
      img.src = preview;
      img.className = 'preview-img';
      img.onclick = () => showASINImage(preview);
      asinInfo.appendChild(img);
    }

    asinBlock.appendChild(asinInfo);

    // ======== Zone jugement manuel ========
    const judgeCol = document.createElement('div');
    judgeCol.className = 'worker-column judge';
	const judgeTitle = document.createElement('div');
	judgeTitle.className = 'judge-title';
	judgeTitle.textContent = "R√©ponse Juge :";
	judgeCol.appendChild(judgeTitle);
    const judgeGroup = document.createElement('div');
    judgeGroup.className = 'checkbox-group';

    const storageKey = `${hitId}_${asin}`;
    const stored = savedJudgeAnswers[storageKey] || [];

    ATTRIBUTES.filter(attr => attr !== "relevance_label").forEach(attr => {
      const label = document.createElement('label');
      const cb = document.createElement('input');

      cb.type = 'checkbox';
      cb.name = `${asin}_${attr}`;
      cb.className = 'juge-checkbox';
      cb.value = attr;

      if (stored.includes(attr)) cb.checked = true;

      cb.addEventListener('change', () => {
        const currentStorage = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');
        const current = currentStorage[storageKey] || [];

        if (cb.checked) {
          if (!current.includes(attr)) current.push(attr);
        } else {
          const idx = current.indexOf(attr);
          if (idx !== -1) current.splice(idx, 1);
        }

        currentStorage[storageKey] = current;
        localStorage.setItem("judgeAnswers", JSON.stringify(currentStorage));
      });

      label.appendChild(cb);
      label.append(` ${attr}`);
      judgeGroup.appendChild(label);
    });

    // üëâ Ajout conditionn√© du select `relevance_label`
    if (ATTRIBUTES.includes("relevance_label")) {
      const label = document.createElement('label');
      label.textContent = " relevance_label: ";
      label.style.display = "block";
      label.style.marginTop = "5px";

      const select = document.createElement('select');
      select.name = `${asin}_relevance_label`;

      ["", "irrelevant", "possible_substitute", "cannot_judge", "exact_match"].forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val || "-- Choisir --";
        select.appendChild(opt);
      });

      const storedRel = stored.find(v => v.startsWith("relevance_label:"));
      if (storedRel) {
        const selectedVal = storedRel.split(":")[1].trim();
        select.value = selectedVal;
      }

      select.addEventListener('change', () => {
        const currentStorage = JSON.parse(localStorage.getItem("judgeAnswers") || '{}');
        let current = currentStorage[storageKey] || [];

        current = current.filter(v => !v.startsWith("relevance_label:"));
        if (select.value) current.push(`relevance_label: ${select.value}`);

        currentStorage[storageKey] = current;
        localStorage.setItem("judgeAnswers", JSON.stringify(currentStorage));
      });

      label.appendChild(select);
      judgeGroup.appendChild(label);
    }

    judgeCol.appendChild(judgeGroup);
    asinBlock.appendChild(judgeCol);

    // ======== Groupement r√©ponses par WorkerId ========
    const grouped = groupByWorkerId(rows, asin);
    const counts = {};
    const responses = {};

    for (const [workerId, values] of Object.entries(grouped)) {
      const simpleKey = values.filter(v => !v.startsWith("relevance_label:")).sort().join('|');
      counts[simpleKey] = (counts[simpleKey] || 0) + 1;
      responses[workerId] = values;
    }

    const maxCount = Math.max(...Object.values(counts));
    const majorKeys = Object.keys(counts).filter(k => counts[k] === maxCount);

    for (const [workerId, values] of Object.entries(responses)) {
      const col = document.createElement('div');
      col.className = 'worker-column';
      col.innerHTML = `<b>${workerId}</b><br>`;

      const simpleAttrs = values.filter(v => !v.startsWith("relevance_label:")).sort();
      const relAttr = values.find(v => v.startsWith("relevance_label:"));
      const relValue = relAttr ? relAttr.split(":")[1].trim() : null;

      const simpleKey = simpleAttrs.join('|');
      const isMajor = majorKeys.includes(simpleKey);

      simpleAttrs.forEach(val => {
        const span = document.createElement('div');
        span.textContent = val;
        span.className = isMajor ? 'majority' : 'minority';
        col.appendChild(span);
      });

      if (relValue) {
        const allRelValues = Object.values(responses)
          .map(v => v.find(a => a.startsWith("relevance_label:")))
          .map(a => a ? a.split(":")[1].trim() : null)
          .filter(v => v != null);

        const relCount = allRelValues.reduce((acc, val) => {
          acc[val] = (acc[val] || 0) + 1;
          return acc;
        }, {});

        const maxRel = Math.max(...Object.values(relCount));
        const majorityRelValues = Object.keys(relCount).filter(k => relCount[k] === maxRel);
        const isMajorRel = majorityRelValues.includes(relValue);

        const relSpan = document.createElement('div');
        relSpan.textContent = relValue;
        relSpan.className = isMajorRel ? 'majority' : 'minority';
        relSpan.style.fontStyle = 'italic';
        col.appendChild(relSpan);
      }

      const commentBox = document.createElement('textarea');
      commentBox.rows = 2;
      commentBox.placeholder = "Commentaire sur ce jugement...";
      commentBox.style.marginTop = "4px";
      commentBox.style.width = "100%";

      const commentKey = `comment_${hitId}_${asin}_${workerId}`;
      const savedComment = localStorage.getItem(commentKey);
      if (savedComment) commentBox.value = savedComment;

      commentBox.addEventListener('input', () => {
        localStorage.setItem(commentKey, commentBox.value);
      });

      col.appendChild(commentBox);

      const rowMatch = rows.find(r => r.WorkerId === workerId && parseFixedJSON(r['Answer.output_data'] || '{}')?.[asin]);
      if (rowMatch && rowMatch.AssignmentId) {
        const assignDisplay = document.createElement('div');
        assignDisplay.textContent = `AssignmentId: ${rowMatch.AssignmentId}`;
        assignDisplay.style.fontSize = "10px";
        assignDisplay.style.color = "#666";
        assignDisplay.style.marginTop = "3px";
        col.appendChild(assignDisplay);
      }

      asinBlock.appendChild(col);
    }

    hitContainer.appendChild(asinBlock);
  });
}





//TAPITRA HATREO NY SHOW HIT id
    function findImage(row, asin) {
      try {
        const matches = parseFixedJSON(row['Input.matches'] || '[]');
        const match = matches.find(m => m.asin === asin);
        return match?.image_url && match.image_url !== 'Product not found' ? match.image_url : null;
      } catch { return null; }
    }

    function groupByWorkerId(rows, asin) {
	  const grouped = {};

	  rows.forEach(row => {
		const workerId = row.WorkerId;
		const outputData = parseFixedJSON(row['Answer.output_data'] || '{}');

		if (!outputData[asin]) return;

		const asinData = outputData[asin];
		const values = [];

		Object.entries(asinData).forEach(([key, val]) => {
		  if (val === true) {
			values.push(key);
		  } else if (key === "relevance_label" && typeof val === 'string') {
			values.push(`relevance_label: ${val}`);
		  }
		});

		grouped[workerId] = values;
	  });

  return grouped;
}

    function showASINImage(src) {
      const img = document.getElementById("floatingASINImage");
      img.src = src;
      img.style.display = "block";
      makeDraggableAndZoomable(img, true);
    }

    function makeDraggableAndZoomable(img, escapable) {
      let isDragging = false, startX, startY;
      img.addEventListener('mousedown', e => {
        isDragging = true;
        startX = e.clientX - img.offsetLeft;
        startY = e.clientY - img.offsetTop;
        img.style.cursor = 'grabbing';
        e.preventDefault();
      });
      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        img.style.left = `${e.clientX - startX}px`;
        img.style.top = `${e.clientY - startY}px`;
      });
      document.addEventListener('mouseup', () => {
        isDragging = false;
        img.style.cursor = 'move';
      });
      img.addEventListener('wheel', e => {
        e.preventDefault();
        const scale = e.deltaY < 0 ? 1.1 : 0.9;
        img.width *= scale;
      });
      if (escapable) {
        document.addEventListener('keydown', e => {
          if (e.key === "Escape") img.style.display = "none";
        });
      }
    }
	
	
	
	
	/**
 * Corrige une cha√Æne JSON en entourant les cl√©s num√©riques longues par des guillemets.
 * Exemple : {1077129068: {...}} => {"1077129068": {...}}
 * @param {string} jsonString - Cha√Æne JSON potentiellement mal form√©e.
 * @returns {object|null} - Objet JSON corrig√©, ou null si erreur.
 */
function parseFixedJSON(jsonString) {
  try {
    // Remplace les cl√©s num√©riques non-quot√©es par des cl√©s entre guillemets
    const fixed = jsonString.replace(/([{,])(\d{7,})(?=\s*:)/g, '$1"$2"');
    return JSON.parse(fixed);
  } catch (e) {
    console.warn("Erreur lors du parsing JSON corrig√© :", e);
    return null;
  }
}


// rotate image by double click
function enableRotationOnWrapper(wrapperId) {
  const wrapper = document.getElementById(wrapperId);
  if (!wrapper) return;

  let angle = 0;
  wrapper.addEventListener('dblclick', () => {
    angle +=90;
    wrapper.style.transform = `rotate(${angle}deg)`;
  });
}

enableRotationOnWrapper('queryRotatableWrapper');      // image + bbox ensemble
enableImageRotation('floatingASINImage');              // ASIN image seule

function enableImageRotation(imgId) {
  const img = document.getElementById(imgId);
  if (!img) return;

  let angle = 0;

  img.addEventListener('dblclick', () => {
    angle += 90; // üü¢ on n‚Äôutilise plus %360 pour √©viter le reset √† 0
    img.style.transform = `rotate(${angle}deg)`;
    img.style.transition = 'transform 0.3s ease';
    img.style.transformOrigin = 'center center';
  });
}

//FONCTION DRESSAGE TABLEAU RESULTAT
document.getElementById('btnSaveData').addEventListener('click', async () => {
  const asinBlocks = document.querySelectorAll('.asin-block');
  const tableau = document.getElementById('tableauResultat');
  const tbody = tableau.querySelector('tbody');
  tbody.innerHTML = '';

  if (!currentHitRow) {
    alert("‚ùó Erreur : aucune donn√©e HIT disponible.");
    return;
  }

  let erreurs = [];
  const assignments = {};

  asinBlocks.forEach(asinBlock => {
    const asinKey = asinBlock.querySelector('.asin-info a')?.textContent.trim().replace("ASIN:", "").trim() || '[ASIN inconnu]';

    // ‚úÖ R√©cup√©rer les valeurs coch√©es (checkboxes) et relevance_label
	const jugeColumn = asinBlock.querySelector('.worker-column.judge');
	let jugeCheckedValues = [];

	if (jugeColumn) {
	  const jugeCheckboxes = jugeColumn.querySelectorAll('input.juge-checkbox:checked');
	  jugeCheckedValues = Array.from(jugeCheckboxes).map(cb => cb.value);

	  // üõ† S√©lecteur dynamique pour relevance_label
	  const relevanceSelect = jugeColumn.querySelector(`select[name="${asinKey}_relevance_label"]`);
	  if (relevanceSelect && relevanceSelect.value && relevanceSelect.value !== 'none') {
		jugeCheckedValues.push(relevanceSelect.value);
	  }
	} else {
	  console.warn(`‚ö†Ô∏è Colonne .worker-column.judge introuvable pour ASIN ${asinKey}`);
	}

	// ‚úÖ Debug
	console.log(`üîç ASIN: ${asinKey}`);
	console.log(`üìå Jugement du juge:`, jugeCheckedValues);

    if (jugeCheckedValues.length === 0) {
      erreurs.push(`${asinKey} (aucun verdict coch√©)`);
      return;
    }

    const workerCols = asinBlock.querySelectorAll('.worker-column:not(.judge)');

    workerCols.forEach(col => {
      const workerId = col.querySelector('b')?.textContent.trim() || '[workerId inconnu]';

      const assignmentDiv = Array.from(col.querySelectorAll('div')).find(d => d.textContent.includes('AssignmentId:'));
      const assignmentId = assignmentDiv ? assignmentDiv.textContent.replace('AssignmentId:', '').trim() : '';

      const commentText = col.querySelector('textarea')?.value.trim() || '';

      if (!workerId || !assignmentId) {
        erreurs.push(`${asinKey} / ${workerId} (manque workerId ou assignmentId)`);
        return;
      }

      if (!assignments[assignmentId]) assignments[assignmentId] = [];

      const assinJson = Array.from(col.querySelectorAll('.majority, .minority'))
        .map(d => d.textContent.trim())
        .filter(Boolean)
        .join(', ');

      assignments[assignmentId].push({
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block: asinBlock
      });
    });
  });

  if (erreurs.length > 0) {
    alert("‚ö†Ô∏è Il y a " + erreurs.length + " erreur(s) :\n\n" + erreurs.join('\n'));
    return;
  }

  for (const [assignmentId, items] of Object.entries(assignments)) {
    items.forEach(item => {
      const {
        asinKey,
        assignmentId,
        workerId,
        jugeCheckedValues,
        commentText,
        assinJson,
        block
      } = item;

      const hitId = currentHitRow['HITId'] || 'inconnu';
      const inputImageURL = currentHitRow['Input.imageURL'] || '';
      const inputBBox = currentHitRow['Input.bbox'] || '';
      const inputContent = currentHitRow['Input.content'] || '';
      const answerOutput = currentHitRow['Answer.output_data'] || '';
      const inputMatches = currentHitRow['Input.matches'] || '{}';
      const marketplace = currentHitRow['Input.marketplace'] || '';

      let amazonImage = '';
      try {
        const matchObj = JSON.parse(inputMatches);
        if (matchObj[asinKey]) amazonImage = matchObj[asinKey].image_url || '';
      } catch (e) {}

      const row = document.createElement('tr');
      [
        hitId,
        assignmentId,
        workerId,
        inputImageURL,
        inputBBox,
        inputContent,
        answerOutput,
        amazonImage,
        marketplace,
        inputMatches,
        asinKey,
        assinJson,
        jugeCheckedValues.join(','),
        commentText
      ].forEach(val => {
        const td = document.createElement('td');
        td.textContent = val;
        row.appendChild(td);
      });

      tbody.appendChild(row);
    });
  }

  tableau.style.display = 'table';
  gotosheet(); // üöÄ Lance l'enregistrement
});



async function gotosheet() {
  const sheetUrlInput = document.getElementById('sheetUrlInput');
  const sheetUrl = sheetUrlInput.value.trim();

  if (!sheetUrl.startsWith('https://docs.google.com/spreadsheets/')) {
    alert('‚ùå Tsy valide ilay Sheet nomenao na tsisy onglet Details ASIN, sa ahoana hozy Enao?');
    return;
  }

  if (!currentHitRow || !currentHitRow['HITId']) {
    alert('‚ùå Misy tsy ampy ny donn√©es hadika, sa ahoana hozy enao?');
    return;
  }

  const hitId = currentHitRow['HITId'];

  const tableau = document.getElementById('tableauResultat');
  if (!tableau) {
    alert('‚ùå Tsy hita mihintsy ilay tableau, sa ahoana hozy enao?');
    return;
  }

  const rows = tableau.querySelectorAll('tbody tr');
  if (rows.length === 0) {
    alert('‚ùå Vide ilay tableau, sa ahoana hozy enao?');
    return;
  }

  // √âtape 1 ‚Äì V√©rification d'existence
	const gasWebAppUrl = document.getElementById("automatisme").value.trim() || localStorage.getItem("gas_webapp_url");

	if (!gasWebAppUrl || !gasWebAppUrl.startsWith("https://script.google.com/macros/")) {
	  alert("‚ùå Tsy norma ilay URL automatisme nomena sa ahoana hozy Enao?.");
	  throw new Error("Cl√© GAS invalide ou manquante");
	}

const checkUrl = `${gasWebAppUrl}?sheetUrl=${encodeURIComponent(sheetUrl)}&hitId=${encodeURIComponent(hitId)}`;

  let overwrite = false;
  let overwriteRange = null;

  try {
    const response = await fetch(checkUrl);
    const result = await response.json();

    if (result.status === "success" && result.found) {
      const confirmation = confirm(`‚ö†Ô∏è HITId efa trait√© io ary ato  (${result.range}). Sa ahoana hozy Enao, Ecrasena ve sa Tsia ?`);
      if (!confirmation) {
        // Op√©ration annul√©e par l‚Äôutilisateur
        return;
      }
      overwrite = true;
      overwriteRange = result.range;
    }
  } catch (err) {
    alert('‚ùå Erreur lors de la v√©rification de doublon : ' + err.message);
    return;
  }

  // √âtape 2 ‚Äì Construction des donn√©es √† envoyer (sans ent√™te)
  const dataToSend = [];
  rows.forEach(tr => {
    const rowData = [];
    tr.querySelectorAll('td').forEach(td => {
      rowData.push(td.textContent.trim());
    });
    dataToSend.push(rowData);
  });

  // √âtape 3 ‚Äì Envoi silencieux vers Apps Script
  //const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby9ggWBwFGM8i0lFByZpaYBdoeEW3uSK1SLHr1zpUCZCfaqLnROmd3a0ac6BX3ffoMLaA/exec';
  const GAS_WEB_APP_URL = localStorage.getItem("gas_webapp_url");

  fetch(GAS_WEB_APP_URL, {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      sheetUrl,
      hitId,
      data: dataToSend,
      range: overwrite ? overwriteRange : null
    })
  });

  // Affichage du sablier avec progression modale
  const overlay = document.getElementById('progressOverlay');
  const progressText = document.getElementById('progressText');
  overlay.style.display = 'flex';

  // Progression simul√©e
  const √©tapes = [1, 10, 20, 35, 45, 60, 75, 85, 95, 99];
  for (let i = 0; i < √©tapes.length; i++) {
    progressText.textContent = `V√©rification en cours... ${√©tapes[i]}%`;
    await new Promise(resolve => setTimeout(resolve, 200)); // D√©lai ajustable
  }

  // √âtape 4 ‚Äì V√©rification finale apr√®s progression
  try {
    const check = await fetch(checkUrl);
    const result = await check.json();

    if (result.status === 'success' && result.found) {
      progressText.innerHTML = '<span class="icon">‚úÖ</span> Details ASIN OK!.';
    } else {
      progressText.innerHTML = '<span class="icon">‚ö†Ô∏è</span> D√©tails ASIN OK!';
    }
  } catch (err) {
    progressText.innerHTML = '‚ùå Erreur lors de la v√©rification finale : ' + err.message;
  }

  // Attente pour afficher le message final, puis fermeture de l'overlay
  await new Promise(resolve => setTimeout(resolve, 1000));
  overlay.style.display = 'none';
}



// CODE DE TEST POUR LA VERIFICATION EXISTANCE DANS DETAILS asin
document.getElementById("verifierdata").addEventListener("click", async () => {
  const hitId = document.getElementById("hitIdInput").value.trim();
  const sheetUrl = document.getElementById("sheetUrlInput").value.trim(); // üü¢ correction ici

  if (!sheetUrl.startsWith('https://docs.google.com/spreadsheets/')) {
    return alert("‚ùå Na tsisy Details ASIN na tsy norma le Sheet picking sa ahoana hozy Enao?.");
  }

  if (!hitId) {
    return alert("Fa aiza ze HitID sa ahoana hozy Enao?");
  }

  const gasWebAppUrl = document.getElementById("automatisme").value.trim() || localStorage.getItem("gas_webapp_url");
	if (!gasWebAppUrl) {
	  alert("‚ùå Ampidiro aloha le URL Script automatisme sa ahoana hozy Enao?.");
	  throw new Error("GAS Web App URL manquant");
	}

const apiUrl = `${gasWebAppUrl}?sheetUrl=${encodeURIComponent(sheetUrl)}&hitId=${encodeURIComponent(hitId)}`;


  try {
    const response = await fetch(apiUrl);
    const result = await response.json();

    const msg = document.getElementById("verifMessage");
    if (result.status === "success") {
      msg.textContent = result.found
        ? "‚úÖ Oui, ce HitID est d√©j√† trait√©"
        : "‚ùå Non, ce HitID n'est pas encore trait√©";
      msg.style.color = result.found ? "green" : "red";

      // ‚úÖ Facultatif : on peut d√©clencher automatiquement le chargement des r√©sultats ici
      if (result.found) {
        //loadSheetResults(hitId);
      }

    } else {
      msg.textContent = "‚ö†Ô∏è Erreur: " + result.message;
      msg.style.color = "orange";
    }
  } catch (err) {
    console.error("Erreur de requ√™te :", err);
    document.getElementById("verifMessage").textContent = "‚ö†Ô∏è Erreur r√©seau ou script.";
  }
});





window.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('progressOverlay');
    if (overlay) overlay.style.display = 'none';
	const input = document.getElementById("automatisme");
  const savedUrl = localStorage.getItem("gas_webapp_url");
  if (savedUrl) {
    input.value = savedUrl;
  }

  // Sauvegarder √† chaque modification
  input.addEventListener("input", () => {
    const url = input.value.trim();
    localStorage.setItem("gas_webapp_url", url);
  });
  });
  
  
 //CHARGEMENT DE URL DE DEPLOYEMENT POUR CHAQUE utilisateur
 window.onload = () => {
  const savedUrl = localStorage.getItem("gas_webapp_url");
  if (savedUrl) {
    document.getElementById("automatisme").value = savedUrl;
  }

  document.getElementById("automatisme").addEventListener("change", () => {
    const url = document.getElementById("automatisme").value.trim();
    localStorage.setItem("gas_webapp_url", url);
  });
};


function showNotification(message) {
  const notif = document.getElementById('notification');
  notif.textContent = message;
  notif.classList.add('show');
  setTimeout(() => {
    notif.classList.remove('show');
  }, 3000);  // disparition apr√®s 3000 ms = 3 secondes
}

document.getElementById("btnSaveData1").addEventListener("click", () => {
  document.getElementById("btnSaveData").click();
});

  </script>
</html>